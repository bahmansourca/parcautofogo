<%- include('partials/header') %>

<a href="/cars" class="btn" style="margin-bottom:12px">← Retour</a>

<div class="hero-card">
  <h1 class="title-xl"><%= car.title %></h1>
  <% if (car.brand || car.model) { %>
    <p class="subtitle"><%= [car.brand, car.model].filter(Boolean).join(' ') %></p>
  <% } %>
  <div class="cta">
    <a class="btn primary" href="tel:+224620056433">Appeler</a>
    <a class="btn" target="_blank" href="https://wa.me/224620056433">WhatsApp</a>
  </div>
</div>

<div class="car-detail-grid">
  <div>
    <div class="car-card">
      <div class="car-image" style="aspect-ratio:16/9;width:100%">
        <% if (car.image) { %>
          <img src="<%= car.image %>" alt="<%= car.title %>" id="main-photo" />
        <% } else { %>
          <div class="placeholder">Pas d'image</div>
        <% } %>
      </div>
    </div>

    <% if (images && images.length) { %>
      <div class="thumb-grid" style="margin-top:10px">
        <% images.forEach(img=>{ %>
          <div class="car-card">
            <div class="car-image">
              <img src="<%= img.image %>" alt="" loading="lazy" />
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
  <aside>
    <div class="hero-card">
      <% if (car.year) { %><p class="meta"><strong>Année:</strong> <%= car.year %></p><% } %>
      <% if (car.fuel_type) { %><p class="meta"><strong>Carburant:</strong> <%= car.fuel_type %></p><% } %>
      <% if (car.price) { %><p class="price" style="margin:6px 0 12px"><%= new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'GNF' }).format(car.price) %></p><% } %>
      <% if (car.description) { %><p class="desc"><%= car.description %></p><% } %>
    </div>
    <div class="hero-card">
      <h3>Contact</h3>
      <ul class="contact-list">
        <li><strong>Propriétaire:</strong> <%= owner.name %></li>
        <li><strong>Téléphone:</strong> <%= owner.phone %></li>
        <li><strong>Email:</strong> <a href="mailto:<%= owner.email %>"><%= owner.email %></a></li>
        <li><strong>Snap:</strong> <%= owner.snap %></li>
        <li><strong>Adresse:</strong> <%= owner.address %></li>
      </ul>
      <div class="cta">
        <a class="btn primary" href="tel:+224620056433">Appel direct</a>
        <a class="btn" target="_blank" href="https://wa.me/224620056433">WhatsApp</a>
      </div>
    </div>
  </aside>
</div>

<%- include('partials/footer') %>

<script>
  (function(){
    const images=[...document.querySelectorAll('#main-photo, .thumb-grid img')].map(el=>el.src);
    let index=0;
    function open(indexToOpen){
      index=indexToOpen;
      const overlay=document.createElement('div');
      overlay.className='lightbox-overlay';
      overlay.innerHTML=`<button class="lb-arrow left" aria-label="Précédent">‹</button>
        <div class="lightbox-content"><img src="${images[index]}" alt="" /></div>
        <button class="lb-arrow right" aria-label="Suivant">›</button>
        <div class="lb-counter">${index+1}/${images.length}</div>`;
      function close(){ document.body.removeChild(overlay); }
      function show(i){
        index=(i+images.length)%images.length;
        overlay.querySelector('.lightbox-content img').src=images[index];
        overlay.querySelector('.lb-counter').textContent=`${index+1}/${images.length}`;
      }
      overlay.addEventListener('click',e=>{ if(e.target===overlay) close(); });
      overlay.querySelector('.left').addEventListener('click',e=>{ e.stopPropagation(); show(index-1); });
      overlay.querySelector('.right').addEventListener('click',e=>{ e.stopPropagation(); show(index+1); });
      let startX=null; overlay.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;});
      overlay.addEventListener('touchend',e=>{ if(startX==null) return; const dx=e.changedTouches[0].clientX-startX; if(Math.abs(dx)>40){ show(dx>0? index-1 : index+1); } startX=null; });
      document.addEventListener('keydown',function onKey(ev){ if(!document.body.contains(overlay)) return document.removeEventListener('keydown',onKey); if(ev.key==='Escape') close(); if(ev.key==='ArrowLeft') show(index-1); if(ev.key==='ArrowRight') show(index+1); });
      document.body.appendChild(overlay);
    }
    const main=document.getElementById('main-photo');
    if(main){ main.style.cursor='zoom-in'; main.addEventListener('click',()=>open(0)); }
    document.querySelectorAll('.thumb-grid img').forEach((img,i)=>{ img.style.cursor='zoom-in'; img.addEventListener('click',()=>open(i+1)); });
  })();
</script>

